Unity向けBLEライブラリの開発にあたり、BLE（Bluetooth Low Energy）の主要な仕様と概念をまとめたドキュメントを以下に示します。

---

## Unity向けBLEライブラリ開発のためのBLE仕様まとめ

### 1. BLE（Bluetooth Low Energy）の概要

BLE（Bluetooth Low Energy）は、少ない電力消費で機器間の通信を可能にする省エネルギー型の無線通信規格です。Bluetooth Classicと比較して、必要な時だけ短時間でデータをやり取りするため、消費電力を大幅に削減できます。これにより、コイン電池一つで数年間稼働するデバイスも実現可能です。

BLEは、ワイヤレスヘッドセット、マウス、キーボードなどの周辺機器だけでなく、スマートホームシステム、医療・フィットネス機器、IoTデバイスなど、多岐にわたるデバイスに利用されています。特に、スマートデバイス（iPhone、Androidスマートフォン/タブレット、Windows/Mac PC、Raspberry PiなどのLinuxボード）との親和性が高いという特徴があります。

BLEは2006年にノキアが「Wibree」として開発し、2009年にBluetooth 4.0の一部として正式発表されました。Bluetooth 4.2以降、IoTデバイス間の接続に重点を置いた改良が加えられ、健康管理、スマートホーム、産業用途などで広く活用されています。

### 2. BLEの基本的な役割：セントラルとペリフェラル

BLE通信では、デバイスは主に「セントラル（Central）」と「ペリフェラル（Peripheral）」のいずれかの役割を担います。

*   **セントラル（親機）**: 主にBLE通信を制御し、他のBLEデバイスに接続を要求する役割です。通常、スマートフォン、タブレット、PC、ゲートウェイなど、高機能な端末がセントラルになります。セントラルは通常、データを要求する側です。
*   **ペリフェラル（子機）**: セントラルからの接続を受け入れ、データを提供する役割を担います。センサー、ビーコン、健康機器、スマートウォッチ、忘れ物タグなどがこの役割を果たします。ペリフェラルは、主にセントラルの要求に応じてデータを送信します。

デバイスによっては、セントラルとペリフェラルの両方の役割を担えるものも存在します。また、1台のセントラル機器は複数台のペリフェラル機器と同時に接続できますが、同時に接続できる台数はセントラル機器の能力に依存します。

### 3. BLEの通信フロー（接続シーケンス）

BLEデバイスが通信を確立する基本的なシーケンスは以下の通りです。

1.  **アドバタイズ（Advertise）**:
    *   ペリフェラル機器は、自身が接続可能であることを周囲に伝えるために「アドバタイズ」と呼ばれる無線信号を定期的に一方的に発信します。これはブロードキャスト通信の一種であり、不特定多数の相手にデータを送信する一方通行の通信方式です。
    *   アドバタイズ信号には、ペリフェラルの名前や属性データを含めることができます。発信周期は自由に設定可能で、100msごとや1秒ごとが多いとされています。
    *   BLEビーコンはこのアドバタイズのみのモードで動作する機器の一例です。
2.  **スキャン（Scan）**:
    *   セントラル機器は、周囲のペリフェラル機器を探すために「スキャン」を行います。
    *   セントラルはスキャンによってアドバタイズ信号を受信し、周囲にどのようなペリフェラル機器が存在するかを認識します。受信した電波の強さ（RSSI）から、ペリフェラル機器との距離感を把握することも可能です。
3.  **接続要求の送信**:
    *   セントラル機器はスキャンで見つけたペリフェラル機器の中から、1対1の通信接続をしたい相手を選択し、その相手に対して接続要求を送信します。
4.  **接続確立（GATT通信への切り替え）**:
    *   ペリフェラル機器はアドバタイズ発信後、短時間接続要求を待ちます。接続要求を受信すると、ペリフェラルはアドバタイズを停止し、セントラルとの1対1の接続通信に切り替わります。この1対1の接続通信は「GATT（Generic Attribute Profile）通信」と呼ばれます。
5.  **データ交換（GATT通信）**:
    *   接続が確立されると、セントラルはペリフェラルのデータを読み取ったり、必要に応じて書き込んだりできるようになります。データのやり取りは、サービス（Service）とキャラクタリスティック（Characteristic）という概念を介して行われます。

### 4. GATT通信とデータ構造：サービス、キャラクタリスティック、UUID

GATT通信は、Bluetoothデバイス間でデータを整理し、交換するためのフレームワークを提供します。

*   **サービス（Service）**: 関連するキャラクタリスティックを機能単位でまとめた論理的なグループ（ラベル）です。例えば、歩数計であれば「歩数計サービス」の中に歩数や歩行時間などのキャラクタリスティックが含まれます。セントラルは接続確立後、まずペリフェラルの持つサービスを調べます。この処理を「サービスディスカバリー」と呼びます。
*   **キャラクタリスティック（Characteristic）**: ペリフェラル機器がセントラル機器に公開して共有するデータ構造です。ペリフェラルとセントラルはこのキャラクタリスティックを介してデータのやり取りを行います。
    *   キャラクタリスティックには属性が決められており、主に以下の種類があります。
        *   **Read**: セントラルがペリフェラルのデータを読み取る。
        *   **Write**: セントラルがペリフェラルにデータを書き込む。
        *   **Notify**: ペリフェラル側でデータが更新された際、セントラルに自動的に通知する（応答不要）。
*   **UUID（Universally Unique Identifier）**:
    *   サービスやキャラクタリスティックには、UUIDという16バイト（128ビット）の一意な識別子が割り当てられます。セントラル機器はUUIDを指定して、キャラクタリスティックのデータ内容にアクセスします。
    *   UUIDには以下の2種類があります。
        *   **定義済UUID**: Bluetooth SIG（Bluetoothの標準化団体）が標準で定義し、割り当てているUUIDです。これらは16バイトのうち14バイトが共通の「BASE UUID」であり、残りの2バイト（4文字）のみが異なります。このため、定義済UUIDは2バイトの短縮表記が許されています。短縮表記はデータを小さくし、送信時間と消費電力の短縮に繋がります。例: Battery Serviceは「180f」、Battery Levelは「2a19」。
        *   **オリジナルUUID（Vendor Specific UUID）**: 開発者が独自に割り当てるUUIDで、必ず16バイトのフルフォーマットで表現する必要があります。標準で合致するサービスやキャラクタリスティックがない場合に作成します。UUIDはコマンドやWebサービスで簡単に生成できます。
*   **プロファイル（Profile）**: 特定の用途に合わせて通信方式や操作手順を標準化したものです。体温計や血圧計などの標準的な製品種別については、Bluetooth SIGが標準的なGATT通信のプロファイルを公開しており、これにより別メーカーの機器間でも互換性を保ちやすくなります。一方で、多くの場合はメーカーが独自に規定する「カスタムプロファイル」が利用されます。

### 5. BLEプロトコルスタックの概要

Bluetooth通信は、プロトコルスタックと呼ばれる階層構造によって成り立っています。このスタックは大きく「コントローラ層」「ホスト層」「アプリケーション層」に分類されます。

*   **コントローラ層**: 物理的な無線通信を担当する下位層です。
*   **ホスト層**: 複雑な通信制御やデータ処理を担当する上位層です。
    *   **GAP層（Generic Access Profile）**: ホスト層の一部であり、機器の接続、認証、暗号化などシステム全体を取りまとめる役割を担っています。Bluetoothに対応した機器がメーカーやアプリケーションの種類を問わずに接続できるようになるのは、このGAP層が標準化されているおかげです。

### 6. ペアリングとボンディング

ペアリングとボンディングは、Bluetoothデバイス間での安全かつ効率的な通信を実現するために重要なプロセスです。これらはGAP層で行われます。

*   **ペアリング（Pairing）**:
    *   Bluetooth機器間でデータの暗号化を行うために、機器同士が相互に秘密鍵を交換し、認証するプロセスです。
    *   このプロセスにより、デバイス間でセキュアな通信経路が確立されます。
*   **ボンディング（Bonding）**:
    *   ペアリングによって交換された秘密鍵を機器に保存するプロセスです。
    *   **利点**: ボンディングが行われると、一度ペアリングしたデバイスは、次回以降の接続時に秘密鍵を再生成・再交換することなく、保存された鍵を使用してスムーズかつ安全に再接続できるようになります。これにより、セントラル機器は広範囲なスキャンを行うことなく、記憶している特定のペリフェラルデバイスのアドレスを対象に効率的な再接続を試みることが可能になり、再接続にかかる時間が大幅に短縮されます。

### 7. BLEの省エネルギー特性と最適化

BLEの最大の特徴はその低消費電力であり、これを最大限に活かすことがデバイス開発において重要です。

*   **省エネルギー機構**:
    *   通信がアクティブでないときにはデバイスをスリープ状態にし、必要な時だけデバイスを起動する制御機能。
    *   通信速度を控えめに設定することで、通信時間を短縮し、消費電力を低減。
*   **省電力化の要素**:
    *   **ハードウェア**: 消費電力が少ないチップの選択。
    *   **ソフトウェア**: デバイスを適切に制御し、スリープ時間を増やす。
*   **消費電力に影響するBLEパラメータ**:
    *   **送信電力（Transmit Power）**: 低いほど消費電力は少ないが、通信範囲に影響。
    *   **アドバタイズ間隔（Advertising Interval）**: 間隔が短いほど発見されやすいが消費電力が増加。ビーコンのようにアドバタイズのみで動作するデバイスでは特に重要。
    *   **接続間隔（Connection Interval）**: 長いほどデバイスがスリープする時間が長くなり、消費電力が減少。
    *   **スレーブレーテンシ（Slave Latency）**: スレーブが接続イベントをスキップできる最大回数を定義し、スリープ期間を長くすることで消費電力を削減。
    *   **キャラクタリスティックのサイズ（Size of Characteristics）**: 読み書きするデータのサイズが大きいほど無線がONになる時間が長くなり、消費電力が増加。データのサイズを最適化することが重要。
    *   **操作タイプ（Operation Types）**: 応答を必要としない操作（例: Write Without ResponseやNotifications）を選択することで、デバイス間の確認パケットのやり取りが不要になり、消費電力を削減できます。

### 8. UnityでのBLE開発に関する補足

Unity自体にはBluetooth通信機能が標準で組み込まれていません。そのため、Android、iOS、Windowsなどの各プラットフォームでBLE通信を行うには、それぞれのOSに対応したネイティブプラグインを開発する必要があります。

*   **Android向け**: UnityのAndroidプラグインとしてBLE通信機能を実装します。
*   **iOS/macOS向け**: AppleのCoreBluetooth Frameworkを利用してBLE通信機能を実装します。
*   **Windows向け**: UWP（Windows Universal Platform）のBLE APIなどを利用してネイティブプラグインを実装します。

これらのネイティブプラグインは、BLEのセントラルとペリフェラルの役割、アドバタイズ、スキャン、接続、GATT通信（サービス、キャラクタリスティックの読み書き、通知など）といった基本的なBLEの仕様に対応するように実装されます。

---